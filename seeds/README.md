# Database Seeders

This directory contains database seeder files for populating tables with initial data.

## How Seeders Work

Seeders use Go and GORM to insert data into the database:
- **Automatic UUID generation**: Primary keys are generated by the database
- **Automatic timestamps**: `created_at` and `updated_at` are handled by GORM
- **Idempotent**: Uses `FirstOrCreate` to avoid duplicates (safe to run multiple times)
- **Environment-aware**: Uses `.env` for database configuration

## Available Commands

```bash
# Run all seeders
make seed

# Run specific seeder
make seed NAME=jenis_buku

# List available seeders
make seed-list

# Rebuild seed tool
make seed-rebuild

# Alternative: Use shell script directly
./seed.sh all
./seed.sh jenis_buku
./seed.sh list
```

## Adding a New Seeder

### Step 1: Create Seeder File

Create a new file in the `seeds/` directory (e.g., `seeds/cities_seed.go`):

```go
package seeds

import (
	"fmt"
	"pustaka-backend/models"
	"gorm.io/gorm"
)

// CitiesSeeder seeds the cities table with initial data
func CitiesSeeder(db *gorm.DB) error {
	fmt.Println("üìù Seeding cities table...")

	// Helper function for string pointers (if needed)
	strPtr := func(s string) *string {
		return &s
	}

	citiesData := []models.City{
		{
			Code: "JKT",
			Name: "Jakarta",
			// Add other fields as needed
		},
		{
			Code: "BDG",
			Name: "Bandung",
		},
		// Add more data...
	}

	created := 0
	skipped := 0

	for _, city := range citiesData {
		var result models.City
		err := db.Where("code = ?", city.Code).FirstOrCreate(&result, city).Error
		if err != nil {
			return fmt.Errorf("failed to seed city with code %s: %w", city.Code, err)
		}
	}

	fmt.Printf("‚úì Cities seeding completed: %d created, %d skipped\n", created, skipped)
	return nil
}
```

### Step 2: Register Seeder in seed.go

Edit `seed.go` and add your seeder to two places:

**1. In `runAllSeeders()` function:**
```go
seeders := []struct {
	name string
	fn   func() error
}{
	{"jenis_buku", func() error { return seeds.JenisBukuSeeder(config.DB) }},
	{"cities", func() error { return seeds.CitiesSeeder(config.DB) }},  // Add this
}
```

**2. In `runSpecificSeeder()` function:**
```go
switch name {
case "jenis_buku":
	err = seeds.JenisBukuSeeder(config.DB)
case "cities":  // Add this
	err = seeds.CitiesSeeder(config.DB)
default:
	log.Fatalf("‚ùå Unknown seeder: %s\n\nAvailable seeders:\n  - jenis_buku\n  - cities\n", name)
}
```

### Step 3: Update seed.sh (Optional)

If you want to add the seeder to the list in `seed.sh`, edit the `list_seeders()` function:

```bash
list_seeders() {
    echo -e "${GREEN}‚ñ∂ jenis_buku${NC}       - Seed jenis_buku table with book types"
    echo -e "${GREEN}‚ñ∂ cities${NC}           - Seed cities table"
    # Add more lines as needed
}
```

### Step 4: Run Your Seeder

```bash
# Run specific seeder
make seed NAME=cities

# Or run all seeders (including your new one)
make seed
```

## Best Practices

1. **Use FirstOrCreate**: Always use `FirstOrCreate` with a unique field (like `code`) to prevent duplicates
2. **Error Handling**: Return descriptive errors with context
3. **Logging**: Add helpful console output to show progress
4. **Idempotent**: Seeders should be safe to run multiple times
5. **Data Quality**: Use realistic, production-like data
6. **Dependencies**: If seeders have dependencies (e.g., cities must exist before addresses), run them in the correct order in `runAllSeeders()`

## Example: Seeder with Foreign Keys

```go
func BooksSeeder(db *gorm.DB) error {
	fmt.Println("üìù Seeding books table...")

	// First, get related entities
	var jenisBuku models.JenisBuku
	if err := db.Where("code = ?", "FIK").First(&jenisBuku).Error; err != nil {
		return fmt.Errorf("jenis_buku not found, please run jenis_buku seeder first: %w", err)
	}

	booksData := []models.Book{
		{
			Code:        "BK001",
			Name:        "Example Book",
			JenisBukuID: jenisBuku.ID,  // Use the UUID from related entity
		},
	}

	for _, book := range booksData {
		var result models.Book
		err := db.Where("code = ?", book.Code).FirstOrCreate(&result, book).Error
		if err != nil {
			return fmt.Errorf("failed to seed book: %w", err)
		}
	}

	fmt.Println("‚úì Books seeding completed")
	return nil
}
```

## Troubleshooting

### Error: "table does not exist"
Make sure you've run migrations first:
```bash
make db-migrate
```

### Error: "connection refused"
Check your `.env` file and ensure the database is running:
```bash
make db-info
```

### Error: "duplicate code or name"
some tables require code or name to be unique, this is how to check:
place this code inside the seeder and modify according your array of
objects to:
- detect the same code in bidangStudiData and print the duplicates before proceeding
- detect the same name in bidangStudiData and print the duplicates before proceeding

```go
    bidangStudiCodes := make(map[string]bool)
    for _, bidangStudi := range bidangStudiData {
        if _, exists := bidangStudiCodes[bidangStudi.Code]; exists {
            return fmt.Errorf("duplicate code found in bidangStudiData: %s", bidangStudi.Code)
        }
        bidangStudiCodes[bidangStudi.Code] = true
    }

    bidangStudiNames := make(map[string]bool)
    for _, bidangStudi := range bidangStudiData {
        if _, exists := bidangStudiNames[bidangStudi.Name]; exists {
            return fmt.Errorf("duplicate name found in bidangStudiData: %s", bidangStudi.Name)
        }
        bidangStudiNames[bidangStudi.Name] = true
    }
```

and run this command in the terminal
```bash
make seed-rebuild && make seed NAME=bidang_studi
```

### Seeder not found
Make sure you:
1. Created the seeder file in `seeds/` directory
2. Registered it in `seed.go`
3. Rebuilt the seed tool: `make seed-rebuild`

## File Structure

```
seeds/
‚îú‚îÄ‚îÄ README.md              # This file
‚îú‚îÄ‚îÄ jenis_buku_seed.go    # Example seeder
‚îî‚îÄ‚îÄ [your_seeder].go      # Add more seeders here

seed.go                    # Main seed runner
seed.sh                    # Shell script wrapper
```
